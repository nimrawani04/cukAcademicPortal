<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: green;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            color: red;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>üéì Functional Academic System Test</h1>
    
    <div class="grid">
        <!-- Student Tests -->
        <div class="container">
            <h2>üë®‚Äçüéì Student Functionality Tests</h2>
            
            <div class="test-section">
                <h3>1. Student Login & Data</h3>
                <input type="email" id="studentEmail" placeholder="student@example.com" value="john.student@test.com">
                <input type="password" id="studentPassword" placeholder="password" value="student123">
                <button onclick="testStudentLogin()">Login as Student</button>
                <button onclick="testStudentData()" id="studentDataBtn" disabled>Load Student Data</button>
                <div id="studentResult"></div>
            </div>

            <div class="test-section">
                <h3>2. Student Leave Application</h3>
                <select id="leaveType">
                    <option value="sick">Sick Leave</option>
                    <option value="personal">Personal Leave</option>
                    <option value="emergency">Emergency Leave</option>
                </select>
                <input type="date" id="fromDate" value="2024-02-01">
                <input type="date" id="toDate" value="2024-02-03">
                <textarea id="leaveReason" placeholder="Reason for leave">Medical appointment</textarea>
                <button onclick="testLeaveApplication()" id="leaveBtn" disabled>Apply for Leave</button>
                <div id="leaveResult"></div>
            </div>

            <div class="test-section">
                <h3>3. Student Data Display</h3>
                <div id="studentDataDisplay"></div>
            </div>
        </div>

        <!-- Teacher Tests -->
        <div class="container">
            <h2>üë®‚Äçüè´ Teacher Functionality Tests</h2>
            
            <div class="test-section">
                <h3>1. Teacher Login & Profile</h3>
                <input type="email" id="teacherEmail" placeholder="teacher@example.com" value="jane.faculty@test.com">
                <input type="password" id="teacherPassword" placeholder="password" value="faculty123">
                <button onclick="testTeacherLogin()">Login as Teacher</button>
                <button onclick="testTeacherProfile()" id="teacherProfileBtn" disabled>Load Teacher Profile</button>
                <div id="teacherResult"></div>
            </div>

            <div class="test-section">
                <h3>2. Attendance Management</h3>
                <select id="studentSelect" disabled>
                    <option value="">Select Student</option>
                </select>
                <input type="text" id="subjectName" placeholder="Subject Name" value="Mathematics">
                <input type="text" id="subjectCode" placeholder="Subject Code" value="MATH101">
                <input type="number" id="totalClasses" placeholder="Total Classes" value="30">
                <input type="number" id="attendedClasses" placeholder="Attended Classes" value="25">
                <button onclick="testAttendanceUpdate()" id="attendanceBtn" disabled>Update Attendance</button>
                <div id="attendanceResult"></div>
            </div>

            <div class="test-section">
                <h3>3. Marks Management</h3>
                <select id="examType">
                    <option value="midterm">Midterm</option>
                    <option value="final">Final</option>
                    <option value="assignment">Assignment</option>
                    <option value="quiz">Quiz</option>
                </select>
                <input type="number" id="totalMarks" placeholder="Marks Obtained" value="85">
                <input type="number" id="maxMarks" placeholder="Maximum Marks" value="100">
                <button onclick="testMarksUpdate()" id="marksBtn" disabled>Add Marks</button>
                <div id="marksResult"></div>
            </div>

            <div class="test-section">
                <h3>4. Leave Review</h3>
                <button onclick="testLeaveReview()" id="leaveReviewBtn" disabled>Load Leave Applications</button>
                <div id="leaveReviewResult"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h3>5. System Log</h3>
        <div id="log"></div>
    </div>

    <script>
        console.log("üîç Functional system test loaded!");
        
        const BACKEND_URL = 'https://cukacademicportal.onrender.com';
        let studentToken = null;
        let teacherToken = null;
        let currentStudents = [];
        let currentLeaves = [];
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId);
            const className = isSuccess ? 'success' : 'error';
            container.innerHTML += `<div class="${className}">${message}</div>`;
        }
        
        // STUDENT TESTS
        async function testStudentLogin() {
            const email = document.getElementById('studentEmail').value;
            const password = document.getElementById('studentPassword').value;
            
            log(`Testing student login: ${email}`);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                log(`Student login response: ${JSON.stringify(data)}`);
                
                if (data.success && data.data.user.role === 'student') {
                    studentToken = data.data.token;
                    showResult('studentResult', '‚úÖ Student login successful!', true);
                    document.getElementById('studentDataBtn').disabled = false;
                    document.getElementById('leaveBtn').disabled = false;
                } else {
                    showResult('studentResult', `‚ùå Student login failed: ${data.message}`, false);
                }
            } catch (error) {
                log(`Student login error: ${error.message}`);
                showResult('studentResult', `‚ùå Student login error: ${error.message}`, false);
            }
        }
        
        async function testStudentData() {
            if (!studentToken) {
                alert('Please login as student first');
                return;
            }
            
            log('Testing student data APIs...');
            
            try {
                // Test dashboard
                const dashboardResponse = await fetch(`${BACKEND_URL}/api/student/dashboard`, {
                    headers: { 'Authorization': `Bearer ${studentToken}` }
                });
                
                if (dashboardResponse.ok) {
                    const data = await dashboardResponse.json();
                    log(`Dashboard: ${JSON.stringify(data)}`);
                    showResult('studentResult', '‚úÖ Dashboard API working!', true);
                    displayStudentData('dashboard', data.data);
                }
                
                // Test attendance
                const attendanceResponse = await fetch(`${BACKEND_URL}/api/student/attendance`, {
                    headers: { 'Authorization': `Bearer ${studentToken}` }
                });
                
                if (attendanceResponse.ok) {
                    const data = await attendanceResponse.json();
                    log(`Attendance: ${JSON.stringify(data)}`);
                    showResult('studentResult', '‚úÖ Attendance API working!', true);
                    displayStudentData('attendance', data.data);
                }
                
                // Test marks
                const marksResponse = await fetch(`${BACKEND_URL}/api/student/marks`, {
                    headers: { 'Authorization': `Bearer ${studentToken}` }
                });
                
                if (marksResponse.ok) {
                    const data = await marksResponse.json();
                    log(`Marks: ${JSON.stringify(data)}`);
                    showResult('studentResult', '‚úÖ Marks API working!', true);
                    displayStudentData('marks', data.data);
                }
                
            } catch (error) {
                log(`Student data error: ${error.message}`);
                showResult('studentResult', `‚ùå Student data error: ${error.message}`, false);
            }
        }
        
        async function testLeaveApplication() {
            if (!studentToken) {
                alert('Please login as student first');
                return;
            }
            
            const leaveData = {
                leaveType: document.getElementById('leaveType').value,
                reason: document.getElementById('leaveReason').value,
                fromDate: document.getElementById('fromDate').value,
                toDate: document.getElementById('toDate').value
            };
            
            log(`Testing leave application: ${JSON.stringify(leaveData)}`);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/student/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${studentToken}`
                    },
                    body: JSON.stringify(leaveData)
                });
                
                const data = await response.json();
                log(`Leave application response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    showResult('leaveResult', '‚úÖ Leave application submitted successfully!', true);
                } else {
                    showResult('leaveResult', `‚ùå Leave application failed: ${data.message}`, false);
                }
            } catch (error) {
                log(`Leave application error: ${error.message}`);
                showResult('leaveResult', `‚ùå Leave application error: ${error.message}`, false);
            }
        }
        
        // TEACHER TESTS
        async function testTeacherLogin() {
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;
            
            log(`Testing teacher login: ${email}`);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                log(`Teacher login response: ${JSON.stringify(data)}`);
                
                if (data.success && data.data.user.role === 'teacher') {
                    teacherToken = data.data.token;
                    showResult('teacherResult', '‚úÖ Teacher login successful!', true);
                    document.getElementById('teacherProfileBtn').disabled = false;
                    document.getElementById('attendanceBtn').disabled = false;
                    document.getElementById('marksBtn').disabled = false;
                    document.getElementById('leaveReviewBtn').disabled = false;
                    
                    // Load students for selection
                    loadStudentsForTeacher();
                } else {
                    showResult('teacherResult', `‚ùå Teacher login failed: ${data.message}`, false);
                }
            } catch (error) {
                log(`Teacher login error: ${error.message}`);
                showResult('teacherResult', `‚ùå Teacher login error: ${error.message}`, false);
            }
        }
        
        async function testTeacherProfile() {
            if (!teacherToken) {
                alert('Please login as teacher first');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/teacher/profile`, {
                    headers: { 'Authorization': `Bearer ${teacherToken}` }
                });
                
                const data = await response.json();
                log(`Teacher profile: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    showResult('teacherResult', '‚úÖ Teacher profile loaded!', true);
                    showResult('teacherResult', `Profile: ${data.data.name} (${data.data.employeeId})`, true);
                }
            } catch (error) {
                log(`Teacher profile error: ${error.message}`);
                showResult('teacherResult', `‚ùå Teacher profile error: ${error.message}`, false);
            }
        }
        
        async function loadStudentsForTeacher() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/teacher/students`, {
                    headers: { 'Authorization': `Bearer ${teacherToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentStudents = data.data;
                    const select = document.getElementById('studentSelect');
                    select.innerHTML = '<option value="">Select Student</option>';
                    
                    data.data.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (${student.rollNumber})`;
                        select.appendChild(option);
                    });
                    
                    select.disabled = false;
                    showResult('teacherResult', `‚úÖ Loaded ${data.data.length} students`, true);
                }
            } catch (error) {
                log(`Load students error: ${error.message}`);
            }
        }
        
        async function testAttendanceUpdate() {
            if (!teacherToken) {
                alert('Please login as teacher first');
                return;
            }
            
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                alert('Please select a student');
                return;
            }
            
            const attendanceData = {
                studentId,
                subject: document.getElementById('subjectName').value,
                subjectCode: document.getElementById('subjectCode').value,
                totalClasses: parseInt(document.getElementById('totalClasses').value),
                attendedClasses: parseInt(document.getElementById('attendedClasses').value),
                semester: 1,
                academicYear: '2024'
            };
            
            log(`Testing attendance update: ${JSON.stringify(attendanceData)}`);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/teacher/attendance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${teacherToken}`
                    },
                    body: JSON.stringify(attendanceData)
                });
                
                const data = await response.json();
                log(`Attendance update response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    showResult('attendanceResult', '‚úÖ Attendance updated successfully!', true);
                    showResult('attendanceResult', `Percentage: ${data.data.percentage.toFixed(1)}%`, true);
                } else {
                    showResult('attendanceResult', `‚ùå Attendance update failed: ${data.message}`, false);
                }
            } catch (error) {
                log(`Attendance update error: ${error.message}`);
                showResult('attendanceResult', `‚ùå Attendance update error: ${error.message}`, false);
            }
        }
        
        async function testMarksUpdate() {
            if (!teacherToken) {
                alert('Please login as teacher first');
                return;
            }
            
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                alert('Please select a student');
                return;
            }
            
            const marksData = {
                studentId,
                subject: document.getElementById('subjectName').value,
                subjectCode: document.getElementById('subjectCode').value,
                examType: document.getElementById('examType').value,
                totalMarks: parseInt(document.getElementById('totalMarks').value),
                maxMarks: parseInt(document.getElementById('maxMarks').value),
                semester: 1,
                academicYear: '2024'
            };
            
            log(`Testing marks update: ${JSON.stringify(marksData)}`);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/teacher/marks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${teacherToken}`
                    },
                    body: JSON.stringify(marksData)
                });
                
                const data = await response.json();
                log(`Marks update response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    showResult('marksResult', '‚úÖ Marks added successfully!', true);
                    showResult('marksResult', `Grade: ${data.data.grade} (${data.data.percentage.toFixed(1)}%)`, true);
                } else {
                    showResult('marksResult', `‚ùå Marks update failed: ${data.message}`, false);
                }
            } catch (error) {
                log(`Marks update error: ${error.message}`);
                showResult('marksResult', `‚ùå Marks update error: ${error.message}`, false);
            }
        }
        
        async function testLeaveReview() {
            if (!teacherToken) {
                alert('Please login as teacher first');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/teacher/leaves`, {
                    headers: { 'Authorization': `Bearer ${teacherToken}` }
                });
                
                const data = await response.json();
                log(`Leave applications: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    currentLeaves = data.data;
                    showResult('leaveReviewResult', `‚úÖ Found ${data.data.length} leave applications`, true);
                    
                    if (data.data.length > 0) {
                        let leaveHTML = '<table><tr><th>Student</th><th>Type</th><th>Days</th><th>Status</th><th>Action</th></tr>';
                        data.data.forEach(leave => {
                            leaveHTML += `
                                <tr>
                                    <td>${leave.studentName}</td>
                                    <td>${leave.leaveType}</td>
                                    <td>${leave.totalDays}</td>
                                    <td>${leave.status}</td>
                                    <td>
                                        ${leave.status === 'pending' ? 
                                            `<button onclick="reviewLeave('${leave.id}', 'approved')">Approve</button>
                                             <button onclick="reviewLeave('${leave.id}', 'rejected')">Reject</button>` : 
                                            'Reviewed'}
                                    </td>
                                </tr>
                            `;
                        });
                        leaveHTML += '</table>';
                        
                        document.getElementById('leaveReviewResult').innerHTML += leaveHTML;
                    }
                } else {
                    showResult('leaveReviewResult', `‚ùå Failed to load leaves: ${data.message}`, false);
                }
            } catch (error) {
                log(`Leave review error: ${error.message}`);
                showResult('leaveReviewResult', `‚ùå Leave review error: ${error.message}`, false);
            }
        }
        
        async function reviewLeave(leaveId, status) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/teacher/leave/${leaveId}/review`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${teacherToken}`
                    },
                    body: JSON.stringify({
                        status,
                        comments: `Leave ${status} by teacher`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('leaveReviewResult', `‚úÖ Leave ${status} successfully!`, true);
                    testLeaveReview(); // Reload
                } else {
                    showResult('leaveReviewResult', `‚ùå Review failed: ${data.message}`, false);
                }
            } catch (error) {
                showResult('leaveReviewResult', `‚ùå Review error: ${error.message}`, false);
            }
        }
        
        function displayStudentData(type, data) {
            const container = document.getElementById('studentDataDisplay');
            
            if (type === 'dashboard') {
                container.innerHTML += `
                    <div class="success">
                        <h4>üìä Dashboard Summary</h4>
                        <p><strong>Name:</strong> ${data.student.name}</p>
                        <p><strong>Roll:</strong> ${data.student.rollNumber}</p>
                        <p><strong>CGPA:</strong> ${data.student.cgpa}</p>
                        <p><strong>Avg Attendance:</strong> ${data.summary.averageAttendance}%</p>
                        <p><strong>Avg Marks:</strong> ${data.summary.averageMarks}%</p>
                    </div>
                `;
            } else if (type === 'attendance') {
                if (data.length === 0) {
                    container.innerHTML += '<div class="error">No attendance data found</div>';
                } else {
                    let html = '<div class="success"><h4>üìÖ Attendance Records</h4><table><tr><th>Subject</th><th>Attended</th><th>Total</th><th>%</th></tr>';
                    data.forEach(record => {
                        html += `<tr><td>${record.subject}</td><td>${record.attendedClasses}</td><td>${record.totalClasses}</td><td>${record.percentage.toFixed(1)}%</td></tr>`;
                    });
                    html += '</table></div>';
                    container.innerHTML += html;
                }
            } else if (type === 'marks') {
                if (data.length === 0) {
                    container.innerHTML += '<div class="error">No marks data found</div>';
                } else {
                    let html = '<div class="success"><h4>üìù Marks Records</h4><table><tr><th>Subject</th><th>Exam</th><th>Marks</th><th>Grade</th></tr>';
                    data.forEach(record => {
                        html += `<tr><td>${record.subject}</td><td>${record.examType}</td><td>${record.totalMarks}/${record.maxMarks}</td><td>${record.grade}</td></tr>`;
                    });
                    html += '</table></div>';
                    container.innerHTML += html;
                }
            }
        }
    </script>
</body>
</html>