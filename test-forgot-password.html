<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Forgot Password - CUK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">üß™ Test Forgot Password Flow</h1>
            
            <!-- Test Form -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-blue-900 mb-4">Test Password Reset Request</h2>
                <form onsubmit="testForgotPassword(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Type</label>
                        <select id="testUserType" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            <option value="">Select User Type</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input 
                            type="email" 
                            id="testEmail" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            placeholder="test@example.com"
                            required
                        >
                    </div>
                    
                    <button 
                        type="submit" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                    >
                        Test Send Reset Link
                    </button>
                </form>
            </div>

            <!-- Test Token Verification -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-green-900 mb-4">Test Token Verification</h2>
                <form onsubmit="testTokenVerification(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reset Token</label>
                        <input 
                            type="text" 
                            id="testToken" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            placeholder="Enter reset token from email"
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Type</label>
                        <select id="testTokenUserType" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            <option value="">Select User Type</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                        </select>
                    </div>
                    
                    <button 
                        type="submit" 
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"
                    >
                        Test Verify Token
                    </button>
                </form>
            </div>

            <!-- Test Password Reset -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-purple-900 mb-4">Test Password Reset</h2>
                <form onsubmit="testPasswordReset(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reset Token</label>
                        <input 
                            type="text" 
                            id="resetToken" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            placeholder="Enter reset token"
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            placeholder="New password (min 8 chars, mixed case, number, symbol)"
                            required
                            minlength="8"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Type</label>
                        <select id="resetUserType" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            <option value="">Select User Type</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                        </select>
                    </div>
                    
                    <button 
                        type="submit" 
                        class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700"
                    >
                        Test Reset Password
                    </button>
                </form>
            </div>

            <!-- Test Results -->
            <div id="testResults" class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Test Results</h2>
                <div id="resultsContent" class="text-sm text-gray-600">
                    No tests run yet. Use the forms above to test the forgot password functionality.
                </div>
            </div>

            <!-- Quick Links -->
            <div class="mt-6 flex space-x-4">
                <a href="/" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">
                    Back to Main Site
                </a>
                <a href="reset-password.html" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                    Test Reset Page
                </a>
            </div>
        </div>
    </div>

    <script>
        // Test forgot password request
        async function testForgotPassword(event) {
            event.preventDefault();
            
            const userType = document.getElementById('testUserType').value;
            const email = document.getElementById('testEmail').value;
            
            addResult(`üß™ Testing forgot password request for ${email} (${userType})...`);
            
            try {
                const response = await apiRequest('/auth/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        userType: userType
                    })
                });
                
                if (response.success) {
                    addResult(`‚úÖ SUCCESS: ${response.message}`, 'success');
                } else {
                    addResult(`‚ùå FAILED: ${response.message}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        // Test token verification
        async function testTokenVerification(event) {
            event.preventDefault();
            
            const token = document.getElementById('testToken').value;
            const userType = document.getElementById('testTokenUserType').value;
            
            addResult(`üß™ Testing token verification for token: ${token.substring(0, 8)}...`);
            
            try {
                const response = await apiRequest(`/auth/verify-reset-token/${token}?userType=${userType}`);
                
                if (response.success) {
                    addResult(`‚úÖ SUCCESS: Token is valid for ${response.data.name} (${response.data.email})`, 'success');
                } else {
                    addResult(`‚ùå FAILED: ${response.message}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        // Test password reset
        async function testPasswordReset(event) {
            event.preventDefault();
            
            const token = document.getElementById('resetToken').value;
            const newPassword = document.getElementById('newPassword').value;
            const userType = document.getElementById('resetUserType').value;
            
            addResult(`üß™ Testing password reset with token: ${token.substring(0, 8)}...`);
            
            try {
                const response = await apiRequest('/auth/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        token: token,
                        newPassword: newPassword,
                        userType: userType
                    })
                });
                
                if (response.success) {
                    addResult(`‚úÖ SUCCESS: ${response.message}`, 'success');
                } else {
                    addResult(`‚ùå FAILED: ${response.message}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        // Add result to the results section
        function addResult(message, type = 'info') {
            const resultsContent = document.getElementById('resultsContent');
            const timestamp = new Date().toLocaleTimeString();
            
            const colorClass = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            }[type] || 'text-gray-600';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `mb-2 p-2 border-l-4 ${type === 'success' ? 'border-green-500 bg-green-50' : type === 'error' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'}`;
            resultDiv.innerHTML = `
                <div class="${colorClass} font-medium">${message}</div>
                <div class="text-xs text-gray-500">${timestamp}</div>
            `;
            
            if (resultsContent.textContent.includes('No tests run yet')) {
                resultsContent.innerHTML = '';
            }
            
            resultsContent.appendChild(resultDiv);
            resultsContent.scrollTop = resultsContent.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addResult('üöÄ Test page loaded. Ready to test forgot password functionality.');
        });
    </script>
</body>
</html>